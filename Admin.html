<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ADMIN | Secure GID Verifier</title>

<!-- Styles (Dark Red Security Alert) -->
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#000;color:#ff2b2b;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .box{width:760px;max-width:95%;background:#0a0a0a;padding:22px;border-radius:12px;border:3px solid #b20000;box-shadow:0 0 30px #7a0000}
  h1{margin:0 0 12px;color:#ff6b6b;text-align:left}
  .row{display:flex;gap:12px}
  input,button,select{padding:10px;border-radius:6px;border:2px solid #ff2b2b;background:#1b0000;color:#ffb6b6;font-size:14px}
  button{cursor:pointer;background:#ff2b2b;color:#000;font-weight:700}
  button:hover{filter:brightness(1.05)}
  table{width:100%;border-collapse:collapse;margin-top:14px;color:#ffb6b6}
  th,td{padding:8px;border:1px solid #ff2b2b;text-align:left;font-size:13px}
  .actions button{margin-right:6px;padding:6px 8px;font-size:12px}
  .small{font-size:12px;color:#ff9d9d}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .status{font-size:13px}
  .danger{color:#ff8b8b}
</style>

<!-- Libraries -->
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
<!-- CryptoJS for AES encryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>
<body>

<div class="box">
  <div class="topbar">
    <h1>ADMIN — Secure GID Verifier</h1>
    <div class="status small">Cloud: <span id="cloudStatus">Not connected</span></div>
  </div>

  <!-- Login -->
  <div id="loginBox">
    <input id="adminPass" type="password" placeholder="Enter Admin Password" />
    <button onclick="login()">LOGIN</button>
    <div class="small" style="margin-top:8px">Default admin password: <strong>admin123</strong> (change in script)</div>
  </div>

  <!-- Admin panel -->
  <div id="adminPanel" style="display:none">
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <input id="nameField" placeholder="Name" />
      <input id="dobField" placeholder="DOB (DD-MM-YYYY)" />
      <input id="idField" placeholder="ID Number" />
      <button onclick="addOrUpdateRecord()">ADD</button>
      <select id="syncMode">
        <option value="both">Sync: Local + Cloud</option>
        <option value="local">Local Only</option>
        <option value="cloud">Cloud Only</option>
      </select>
    </div>

    <div style="margin-top:12px">
      <table id="recordsTable">
        <thead>
          <tr><th>Name</th><th>DOB</th><th>ID</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <button onclick="exportRecords()">EXPORT (JSON)</button>
      <button onclick="clearAll()">CLEAR ALL (Local+Cloud)</button>
      <div class="small danger" id="note">Note: Client-side security is limited; for production use server-side auth.</div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIGS (Change these) ====== */
const ADMIN_PASSWORD = "admin123"; // change immediately
const AES_SECRET = "replace_with_long_secret_key_rajan"; // change to long secret
/* Firebase config - paste YOUR firebase config below */
const FIREBASE_CONFIG = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  // ...other props from your Firebase console
};
/* ====== END CONFIGS ====== */

/* ====== FIREBASE INIT ====== */
let db = null;
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  db = firebase.firestore();
  document.getElementById("cloudStatus").textContent = "Configured (not necessarily accessible)";
} catch(e) {
  console.warn("Firebase init failed:", e);
}

/* Utility: AES encrypt/decrypt */
function encryptObj(obj) {
  const s = JSON.stringify(obj);
  return CryptoJS.AES.encrypt(s, AES_SECRET).toString();
}
function decryptToObj(cipher) {
  try {
    const bytes = CryptoJS.AES.decrypt(cipher, AES_SECRET);
    const str = bytes.toString(CryptoJS.enc.Utf8);
    return JSON.parse(str);
  } catch(e) {
    return null;
  }
}

/* Local storage helpers (encrypted) */
const LOCAL_KEY = "secure_records_v1_encrypted";

function saveLocal(records) {
  const cipher = encryptObj(records);
  localStorage.setItem(LOCAL_KEY, cipher);
}
function loadLocal() {
  const cipher = localStorage.getItem(LOCAL_KEY);
  if (!cipher) return [];
  const data = decryptToObj(cipher);
  return Array.isArray(data) ? data : [];
}

/* Cloud helpers (Firestore) — collection: gid_records */
async function cloudAdd(record) {
  if (!db) throw new Error("Firestore not initialized");
  const docRef = await db.collection("gid_records").add(record);
  return docRef.id;
}
async function cloudSetAll(records) {
  if (!db) throw new Error("Firestore not initialized");
  const col = db.collection("gid_records");
  // naive approach: delete all then write new (simple client-side demo)
  const snapshot = await col.get();
  const batch = db.batch();
  snapshot.forEach(d=> batch.delete(d.ref));
  await batch.commit();
  // write new
  for (const r of records) {
    await col.add(r);
  }
}
async function cloudGetAll() {
  if (!db) throw new Error("Firestore not initialized");
  const snapshot = await db.collection("gid_records").get();
  const out = [];
  snapshot.forEach(d => out.push({ id: d.id, ...d.data() }));
  return out;
}
async function cloudDeleteAll() {
  if (!db) throw new Error("Firestore not initialized");
  const snapshot = await db.collection("gid_records").get();
  const batch = db.batch();
  snapshot.forEach(d => batch.delete(d.ref));
  await batch.commit();
}

/* UI + Operations */
let editIndex = -1;

function login(){
  const pass = document.getElementById("adminPass").value;
  if(pass === ADMIN_PASSWORD){
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadAndRender();
  } else {
    alert("⚠️ Wrong Password!");
  }
}

async function addOrUpdateRecord(){
  const n = document.getElementById("nameField").value.trim();
  const d = document.getElementById("dobField").value.trim();
  const id = document.getElementById("idField").value.trim();
  if(!n||!d||!id){ alert("Enter all fields"); return; }

  const syncMode = document.getElementById("syncMode").value;

  let records = loadLocal();

  if(editIndex >= 0){
    // update
    records[editIndex] = { name:n, dob:d, idnum:id };
    editIndex = -1;
  } else {
    records.push({ name:n, dob:d, idnum:id });
  }

  // Save based on sync mode
  if(syncMode === "local" || syncMode === "both") {
    saveLocal(records);
  }
  if((syncMode === "cloud" || syncMode === "both") && db) {
    try {
      await cloudSetAll(records);
      document.getElementById("cloudStatus").textContent = "Synced";
    } catch(e){ console.warn(e); document.getElementById("cloudStatus").textContent = "Cloud error"; }
  }

  // reset form and render
  document.getElementById("nameField").value = document.getElementById("dobField").value = document.getElementById("idField").value = "";
  renderTable(records);
}

function renderTable(records){
  const tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML = "";
  records.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.dob)}</td><td>${escapeHTML(r.idnum)}</td>
      <td class="actions">
        <button onclick="editRecord(${idx})">Edit</button>
        <button onclick="deleteRecord(${idx})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function editRecord(idx){
  const records = loadLocal();
  const r = records[idx];
  if(!r) return alert("Record not found");
  document.getElementById("nameField").value = r.name;
  document.getElementById("dobField").value = r.dob;
  document.getElementById("idField").value = r.idnum;
  editIndex = idx;
}

function deleteRecord(idx){
  if(!confirm("Delete this record?")) return;
  let records = loadLocal();
  records.splice(idx,1);
  saveLocal(records);
  // also update cloud (best effort)
  if(db) cloudSetAll(records).catch(()=>document.getElementById("cloudStatus").textContent = "Cloud error");
  renderTable(records);
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

function loadAndRender(){
  // load local encrypted; if none but cloud exists fetch cloud
  let records = loadLocal();
  if(records.length === 0 && db){
    cloudGetAll().then(cloudRecords => {
      if(cloudRecords && cloudRecords.length>0){
        // cloud records may have id field — strip it
        const arr = cloudRecords.map(r=>({ name:r.name, dob:r.dob, idnum:r.idnum }));
        saveLocal(arr); // persist encrypted locally
        renderTable(arr);
        document.getElementById("cloudStatus").textContent = "Loaded from cloud";
      } else {
        renderTable([]);
      }
    }).catch(e=>{ console.warn(e); renderTable([]); });
  } else {
    renderTable(records);
  }
}

function exportRecords(){
  const records = loadLocal();
  const blob = new Blob([JSON.stringify(records,null,2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "records.json"; a.click();
  URL.revokeObjectURL(url);
}

function clearAll(){
  if(!confirm("Clear ALL records locally and in cloud?")) return;
  localStorage.removeItem(LOCAL_KEY);
  if(db) cloudDeleteAll().then(()=>{ alert("Cleared both local and cloud (if configured)"); renderTable([]); }).catch(()=>{ alert("Cleared local, cloud failed"); renderTable([]); });
  else { alert("Cleared local"); renderTable([]); }
}

/* initial hint: load any local data if present */
(function init(){
  const local = loadLocal();
  if(local.length>0) document.getElementById("cloudStatus").textContent = "Local data present";
})();
</script>

</body>
</html>
